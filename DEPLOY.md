# Руководство по деплою BarBoss на Vercel

## ✅ Быстрый ответ на ваш вопрос

**Да, если у вас подключен GitHub, все будет работать автоматически!**

После первого деплоя:
- ✅ Каждый `git push origin main` → автоматический деплой в Production
- ✅ Каждый Pull Request → автоматический Preview деплой  
- ✅ Vercel отслеживает изменения через GitHub webhooks
- ✅ Уведомления в GitHub о статусе деплоя

**Вам не нужно ничего делать вручную после первого деплоя!**

## Быстрый старт

Если у вас уже подключен GitHub репозиторий, Vercel автоматически задеплоит приложение при каждом push в main ветку.

## Пошаговая инструкция

### Шаг 1: Подготовка репозитория GitHub

1. Убедитесь, что код закоммичен и запушен в GitHub:
   ```bash
   git add .
   git commit -m "Fix server actions export for Vercel deployment"
   git push origin main
   ```

2. Проверьте, что `.env.local` в `.gitignore` (секреты не должны попадать в репозиторий)

### Шаг 2: Регистрация на Vercel

1. Перейдите на https://vercel.com
2. Нажмите "Sign Up" и войдите через GitHub
3. Разрешите Vercel доступ к вашим репозиториям

### Шаг 3: Создание проекта

1. В Vercel Dashboard нажмите "Add New Project"
2. Найдите ваш репозиторий `studio` (или как он называется)
3. Нажмите "Import"

### Шаг 4: Настройка проекта

Vercel автоматически определит Next.js, но проверьте настройки:

- **Framework Preset**: Next.js (должно определиться автоматически)
- **Root Directory**: `./` (по умолчанию)
- **Build Command**: `npm run build` (по умолчанию)
- **Output Directory**: `.next` (по умолчанию)
- **Install Command**: `npm install` (по умолчанию)

### Шаг 5: Настройка переменных окружения

**ВАЖНО:** Это критический шаг! Без переменных окружения приложение не будет работать.

1. В настройках проекта нажмите "Environment Variables"
2. Добавьте следующие переменные:

#### Обязательные (Firebase):

```
NEXT_PUBLIC_FIREBASE_API_KEY=ваш_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=ваш_project_id.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=ваш_project_id
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=ваш_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=ваш_app_id
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=ваш_measurement_id
```

#### Опциональные:

```
GOOGLE_GENAI_API_KEY=ваш_google_genai_key (для AI-анализа)
```

**Где взять Firebase credentials:**
1. Откройте Firebase Console: https://console.firebase.google.com/
2. Выберите ваш проект: `studio-7924133843-7f552`
3. Перейдите в Project Settings (⚙️) → General
4. Прокрутите до "Your apps" → Web app
5. Скопируйте значения из конфигурации

**Важно:** Для каждой переменной выберите окружения:
- ✅ Production
- ✅ Preview (опционально)
- ✅ Development (опционально)

### Шаг 6: Деплой

1. Нажмите "Deploy"
2. Дождитесь завершения сборки (2-5 минут)
3. После успешного деплоя вы получите URL: `ваш-проект.vercel.app`

## Автоматический деплой через GitHub

**Да, все будет работать автоматически!** 

После первого деплоя:

1. ✅ Каждый push в `main` ветку → автоматический деплой в Production
2. ✅ Каждый Pull Request → автоматический Preview деплой
3. ✅ Vercel отслеживает изменения в репозитории
4. ✅ Уведомления о статусе деплоя в GitHub

### Как это работает:

```
Вы делаете: git push origin main
    ↓
GitHub получает изменения
    ↓
Vercel видит изменения (через webhook)
    ↓
Vercel автоматически запускает сборку
    ↓
Деплой на production URL
```

## Проверка после деплоя

После успешного деплоя проверьте:

1. ✅ Приложение открывается по URL
2. ✅ Авторизация работает (Firebase Auth)
3. ✅ Данные загружаются (Firestore)
4. ✅ PWA работает (можно установить как приложение)
5. ✅ Офлайн-режим работает

## Настройка домена (опционально)

Если хотите использовать свой домен:

1. В Vercel: Settings → Domains
2. Добавьте ваш домен (например, `barboss.com`)
3. Настройте DNS записи в вашем регистраторе домена:
   - Добавьте CNAME запись: `www` → `cname.vercel-dns.com`
   - Или A запись для корневого домена (см. инструкции Vercel)

## Обновление приложения

После подключения GitHub, для обновления приложения просто:

```bash
git add .
git commit -m "Описание изменений"
git push origin main
```

Vercel автоматически задеплоит новую версию!

## Миграция данных для персональных продуктов

После деплоя новой версии необходимо выполнить миграцию существующих продуктов в библиотеку:

1. Убедитесь, что Firestore indexes задеплоены:
   ```bash
   firebase deploy --only firestore:indexes
   ```

2. Убедитесь, что Firestore rules задеплоены:
   ```bash
   firebase deploy --only firestore:rules
   ```

3. Запустите скрипт миграции (требует Firebase Admin SDK):
   ```bash
   npx tsx scripts/migrate-products-to-library.ts
   ```

   Или создайте временную страницу в админке для запуска миграции через UI.

4. Проверьте результаты миграции в Firebase Console

**Важно:** Миграция должна быть выполнена ПОСЛЕ деплоя новой версии кода, чтобы новые поля были доступны.

## Миграция продуктов в библиотеку и создание премиксов

Для заполнения общей библиотеки продуктов и создания начального набора премиксов используйте скрипт `seed-library-products-and-premixes.ts`.

**Внимание:** Этот скрипт мигрирует ВСЕ продукты в общую библиотеку (операция необратима)!

### Требования

1. Установлен Firebase Admin SDK:
   ```bash
   npm install firebase-admin
   ```

2. Настроен доступ к Firestore через один из способов:
   - Файл `serviceAccountKey.json` в корне проекта
   - Переменная окружения `FIREBASE_SERVICE_ACCOUNT_KEY` с JSON содержимым service account key
   - Default credentials (для локальной разработки с gcloud)

### Запуск скрипта

```bash
npx tsx scripts/seed-library-products-and-premixes.ts
```

### Что делает скрипт

1. **Мигрирует все продукты в библиотеку:**
   - Устанавливает `isInLibrary: true` для всех продуктов (кроме премиксов)
   - Удаляет поле `barId` у всех продуктов
   - Все продукты становятся доступными для всех пользователей

2. **Создает 10 популярных премиксов:**
   - Лонг Айленд Айс Ти
   - Маргарита
   - Московский Мул
   - Мохито
   - Пина Колада
   - Космополитен
   - Секс на пляже
   - Б-52
   - Дайкири
   - Отвертка

   Премиксы создаются в библиотеке и используют продукты из базы данных.

### Важные замечания

- **Необратимость:** Миграция продуктов в библиотеку необратима - все продукты станут общими для всех пользователей
- **Зависимости:** Некоторые ингредиенты (например, соки) могут отсутствовать в базе - такие премиксы будут пропущены с предупреждением
- **Порядок выполнения:** Скрипт сначала мигрирует продукты, затем создает премиксы (чтобы премиксы могли найти ингредиенты в библиотеке)

### Проверка результатов

После выполнения скрипта:

1. Проверьте в Firebase Console, что продукты имеют `isInLibrary: true`
2. Убедитесь, что премиксы созданы в коллекции `products` с `category: 'Premix'`
3. Проверьте, что премиксы доступны в приложении через страницу библиотеки премиксов

## Troubleshooting

### Ошибка сборки

Если сборка падает:
1. Проверьте логи в Vercel Dashboard
2. Убедитесь, что все переменные окружения установлены
3. Проверьте, что код компилируется локально: `npm run build`

### Ошибка "Missing environment variable"

1. Проверьте, что все Firebase переменные добавлены в Vercel
2. Убедитесь, что переменные добавлены для окружения "Production"

### Приложение не работает после деплоя

1. Проверьте консоль браузера (F12) на ошибки
2. Проверьте, что Firebase credentials правильные
3. Убедитесь, что Firestore Security Rules развернуты

## Полезные ссылки

- Vercel Dashboard: https://vercel.com/dashboard
- Firebase Console: https://console.firebase.google.com/
- Документация Vercel: https://vercel.com/docs

