/**
 * Core Philosophy:
 * This ruleset implements a role-based access control (RBAC) model combined with
 * user ownership and bar membership. There are three primary levels of access:
 * 1. Admins: Have global read and write permissions across all data. Admin status
 *    is determined by the existence of a document in the `/roles_admin` collection.
 * 2. Bar Owners: Users designated as the `ownerUserId` on a `/bars/{barId}` document
 *    have full control over that bar and all of its nested data.
 * 3. Bar Members: Users who have a document in the `/bars/{barId}/members` subcollection
 *    can access data within that bar according to their assigned role.
 * 4. Authenticated Users: Can manage their own user profile in `/users/{userId}`
 *    and can create new bars, which they will then own.
 *
 * Data Structure:
 * - `/users/{userId}`: Stores private user profiles, secured by user ID.
 * - `/roles_admin/{userId}`: A simple collection for fast admin privilege checks.
 * - `/products/{productId}`: A global catalog of products. Authenticated users
 *   can read and add to this list.
 * - `/bars/{barId}`: Top-level collection for bar data.
 * - `/bars/{barId}/members/{userId}`: Subcollection defining user roles within a bar.
 * - `/bars/{barId}/inventorySessions/...`: Private data for a bar, accessible only
 *   to its members (owners and staff).
 *
 * Key Security Decisions:
 * - Admin Role Management: The `/roles_admin` collection is read-only from the
 *   client to prevent privilege escalation.
 * - No User Listing: Listing the entire `/users` collection is disallowed to protect user privacy.
 * - Bar Subcollection Privacy: All sensitive sub-data (like inventory) is private
 *   to the bar's members. This is enforced using `exists()` and `get()` calls on
 *   the parent bar's `members` subcollection.
 * - List Queries: `allow list` rules must not rely on `get` or `exists` calls. 
 *   Therefore, client queries must include `where` clauses that can be validated
 *   against the `request` object (e.g., `where('createdByUserId', '==', request.auth.uid)`).
 *
 * Denormalization for Authorization:
 * The `ownerUserId` on a `/bars/{barId}` document is the ultimate source of truth
 * for ownership. For performance, role-based access for non-owners is checked
 * via the `/bars/{barId}/members/{userId}` subcollection, avoiding complex joins.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the current user has admin privileges.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Checks if the currently authenticated user's ID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Checks if the document being written to already exists.
     */
    function resourceExists() {
      return resource != null;
    }

    /**
     * Checks if the requesting user is the owner of a specific bar.
     */
    function isBarOwner(barId) {
      let barDoc = get(/databases/$(database)/documents/bars/$(barId));
      return barDoc.data.ownerUserId == request.auth.uid;
    }

    /**
     * Checks if the user is a member of the bar (either as staff or owner).
     */
    function isBarMember(barId) {
      let isExplicitMember = exists(/databases/$(database)/documents/bars/$(barId)/members/$(request.auth.uid));
      return isBarOwner(barId) || isExplicitMember;
    }

    // ------------------------------------------------------------------------
    // Authorization Logic Functions
    // ------------------------------------------------------------------------
    
    /**
     * Determines if a user can read sensitive data within a specific bar's subcollections.
     * Access is granted to the bar members or an admin.
     */
    function canReadBarData(barId) {
      return isBarMember(barId) || isAdmin();
    }

    /**
     * Determines if a user can write sensitive data within a specific bar's subcollections.
     * Access is granted to the bar members or an admin.
     * Specific role checks (e.g., manager vs. bartender) can be added here.
     */
    function canWriteBarData(barId) {
      // For now, any member can write. This can be refined with role checks.
      // e.g., get(/databases/$(database)/documents/bars/$(barId)/members/$(request.auth.uid)).data.role == 'manager'
      return isBarMember(barId) || isAdmin();
    }


    // ------------------------------------------------------------------------
    // Data Validation Functions (Prototyping Mode: Authorization-critical fields only)
    // ------------------------------------------------------------------------

    /**
     * On create, validates the user is creating their own profile and setting the ID correctly.
     */
    function isCreatingOwnUser(userId) {
      let isRoleValid = request.resource.data.role == 'manager'; // Default role
      return isOwner(userId) && request.resource.data.id == userId && isRoleValid;
    }

    /**
     * On update, ensures the user's unique ID and role remain immutable by non-admins.
     */
    function isUserUpdateValid() {
      return request.resource.data.id == resource.data.id && request.resource.data.role == resource.data.role;
    }

    /**
     * On create, validates the user is setting themselves as the owner of the new bar.
     */
    function isCreatingOwnBar() {
      return request.resource.data.ownerUserId == request.auth.uid;
    }

    /**
     * On update, ensures the bar's owner ID is immutable.
     */
    function isBarUpdateValid() {
      return request.resource.data.ownerUserId == resource.data.ownerUserId;
    }
    
    /**
     * Validates that the role being assigned is a valid one.
     */
    function isValidMemberRole() {
        return request.resource.data.role in ['manager', 'bartender'];
    }

    /**
     * On create, validates the product has all required fields.
     */
    function isProductCreateValid() {
      let data = request.resource.data;
      return data.name is string && data.name.size() > 1 &&
             data.category is string &&
             data.bottleVolumeMl is number && data.bottleVolumeMl > 0 &&
             data.costPerBottle is number && data.costPerBottle > 0 &&
             data.portionVolumeMl is number && data.portionVolumeMl > 0 &&
             data.sellingPricePerPortion is number && data.sellingPricePerPortion > 0 &&
             data.isActive == true;
    }
    
    /**
     * On update, ensures critical product fields are not changed by non-admins.
     */
    function isProductUpdateValid() {
       let data = request.resource.data;
       let oldData = resource.data;
       return data.name == oldData.name &&
              data.category == oldData.category &&
              data.bottleVolumeMl == oldData.bottleVolumeMl &&
              data.costPerBottle == oldData.costPerBottle &&
              data.portionVolumeMl == oldData.portionVolumeMl &&
              data.sellingPricePerPortion == oldData.sellingPricePerPortion;
    }
    
    /**
     * On create, validates the session is linked to the correct bar and created by a bar member.
     */
    function isInventorySessionCreateValid(barId) {
      return request.resource.data.barId == barId && request.resource.data.createdByUserId == request.auth.uid;
    }
    
    /**
     * On update, ensures the session's link to its bar and creator are immutable.
     */
    function isInventorySessionUpdateValid() {
      return request.resource.data.barId == resource.data.barId && request.resource.data.createdByUserId == resource.data.createdByUserId;
    }

    /**
     * On create, validates the line item is linked to the correct parent session.
     */
    function isInventoryLineCreateValid(inventorySessionId) {
      return request.resource.data.inventorySessionId == inventorySessionId;
    }

    /**
     * On update, ensures the line item's link to its parent session is immutable.
     */
    function isInventoryLineUpdateValid() {
      return request.resource.data.inventorySessionId == resource.data.inventorySessionId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to the admin role collection.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list, create, update, delete: if false; // Must be managed server-side
    }

    /**
     * @description Secures user profile documents.
     */
    match /users/{userId} {
      // Admins can read any user profile, users can read their own.
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false; // Protect user privacy by default.
      allow create: if isCreatingOwnUser(userId);
      // Users can update their own profile, admins can update any. Role is immutable.
      allow update: if (isOwner(userId) && isUserUpdateValid()) || isAdmin();
      allow delete: if (isOwner(userId) || isAdmin()) && resourceExists();
    }
    
    /**
     * @description Global product catalog.
     */
    match /products/{productId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn() && isProductCreateValid();
        // Admins can edit anything. Regular users can only update isActive.
        allow update: if resourceExists() && (isAdmin() || isProductUpdateValid());
        allow delete: if isAdmin() && resourceExists();
    }

    /**
     * @description Secures the top-level bar documents.
     */
    match /bars/{barId} {
      // Bar info is readable by its members or admins.
      allow get: if isBarMember(barId) || isAdmin();
      // Public list of bars is allowed for discovery features.
      allow list: if true; 
      allow create: if isSignedIn() && isCreatingOwnBar();
      allow update: if (isBarOwner(barId) || isAdmin()) && resourceExists() && isBarUpdateValid();
      allow delete: if (isBarOwner(barId) || isAdmin()) && resourceExists();

      /**
       * @description Controls access to the list of bar members.
       * Only bar owners and admins can manage the staff list.
       */
      match /members/{userId} {
        allow get, list: if canReadBarData(barId);
        // Only owner or admin can add/remove/change roles of members
        allow create, update: if (isBarOwner(barId) || isAdmin()) && isValidMemberRole();
        allow delete: if isBarOwner(barId) || isAdmin();
      }

      /**
       * @description Secures inventory session data for a bar.
       */
      match /inventorySessions/{inventorySessionId} {
        allow get: if canReadBarData(barId);
        // User can only list sessions they created OR if they are an admin.
        allow list: if (request.query.createdByUserId == request.auth.uid) || isAdmin();
        allow create: if canWriteBarData(barId) && isInventorySessionCreateValid(barId);
        allow update: if canWriteBarData(barId) && resourceExists() && isInventorySessionUpdateValid();
        allow delete: if canWriteBarData(barId) && resourceExists();

        /**
         * @description Secures individual line items within an inventory session.
         */
        match /lines/{inventoryLineId} {
          allow get, list: if canReadBarData(barId);
          allow create: if canWriteBarData(barId) && isInventoryLineCreateValid(inventorySessionId);
          allow update: if canWriteBarData(barId) && resourceExists() && isInventoryLineUpdateValid();
          allow delete: if canWriteBarData(barId) && resourceExists();
        }
      }
      
      /**
       * @description Secures supplier data for a bar.
       */
      match /suppliers/{supplierId} {
        allow get: if canReadBarData(barId);
        allow list, create, update, delete: if canWriteBarData(barId);
      }

      /**
       * @description Secures purchase order data for a bar.
       */
      match /purchaseOrders/{purchaseOrderId} {
        allow get: if canReadBarData(barId);
        allow list, create, update, delete: if canWriteBarData(barId);

        /**
         * @description Secures line items within a purchase order.
         */
        match /lines/{purchaseOrderLineId} {
          allow get: if canReadBarData(barId);
          allow list, create, update, delete: if canWriteBarData(barId);
        }
      }
    }
  }
}
