/**
 * Core Philosophy:
 * This ruleset implements a role-based access control (RBAC) model combined with
 * user ownership and bar membership. There are three primary levels of access:
 * 1. Admins: Have global read and write permissions across all data. Admin status
 *    is determined by the existence of a document in the `/roles_admin` collection.
 * 2. Bar Owners: Users designated as the `ownerUserId` on a `/bars/{barId}` document
 *    have full control over that bar and all of its nested data. This is also reinforced
 *    by the convention that barId is 'bar_' + userId for the owner's primary bar.
 * 3. Bar Members: Users who have a document in the `/bars/{barId}/members` subcollection
 *    can access data within that bar according to their assigned role.
 * 4. Authenticated Users: Can manage their own user profile in `/users/{userId}`
 *    and can create new bars, which they will then own.
 *
 * Key Security Decisions for LIST operations:
 * `allow list` rules MUST NOT use `get()` or `exists()` calls to other documents.
 * The primary mechanism for subcollection listing is verifying ownership via barId structure
 * and ensuring the client query filters by that `barId`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Checks if the user is the owner of the bar by inspecting the barId string.
     * This is FAST and SAFE for LIST rules because it performs no database reads.
     * It relies on the convention that barId is `bar_${userId}` for the primary bar.
     */
    function isBarOwnerByPath(barId) {
      return barId == 'bar_' + request.auth.uid;
    }
    
    /**
     * Checks if the user is a member of the bar (either as staff or owner).
     * SAFE for get, create, update, delete. UNSAFE for list.
     */
    function isBarMemberByRead(barId) {
      let barDoc = get(/databases/$(database)/documents/bars/$(barId));
      if (barDoc.data.ownerUserId == request.auth.uid) {
        return true;
      }
      return exists(/databases/$(database)/documents/bars/$(barId)/members/$(request.auth.uid));
    }
    
    // ------------------------------------------------------------------------
    // Data Validation Functions
    // ------------------------------------------------------------------------
    
    function isUserSchema(data) {
      return data.id == request.auth.uid &&
             data.displayName is string && data.displayName.size() > 0 &&
             data.email is string &&
             data.role in ['admin', 'manager', 'bartender'] &&
             data.createdAt is timestamp;
    }
    
    function isBarSchema(data) {
       return data.id is string && data.id.size() > 0 &&
              data.name is string && data.name.size() > 0 &&
              data.location is string &&
              data.ownerUserId == request.auth.uid;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    match /users/{userId} {
      allow read: if isSignedIn() && isOwner(userId);
      
      allow create: if isSignedIn() 
                    && isOwner(userId) 
                    && isUserSchema(request.resource.data);

      allow update: if isSignedIn() 
                    && isOwner(userId)
                    // Fields that cannot be changed
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.email == resource.data.email
                    && request.resource.data.createdAt == resource.data.createdAt;
      
      allow delete: if false; // Users should not be able to delete their own accounts through the app
    }
    
    match /products/{productId} {
        allow read, list: if isSignedIn();
        // For simplicity, any signed-in user can add/edit products.
        // In a real-world scenario, this would likely be restricted to admins.
        allow create, update: if isSignedIn();
        allow delete: if false; // Deletions should be soft (isActive: false) or admin-only
    }

    match /bars/{barId} {
      // The user can create a bar document if the barId corresponds to their own userId.
      allow create: if isSignedIn() 
                    && isBarOwnerByPath(barId)
                    && isBarSchema(request.resource.data);

      // The owner of the bar can read, update, and delete it.
      allow read, update, delete: if isBarOwnerByPath(barId);

      match /members/{memberId} {
        // The bar owner can manage members.
        allow read, list, create, update, delete: if isBarOwnerByPath(barId);
      }
      
      match /suppliers/{supplierId} {
         // The bar owner can manage suppliers for their bar.
         allow read, list, create, update, delete: if isBarOwnerByPath(barId);
      }

      match /purchaseOrders/{purchaseOrderId} {
        // The bar owner can manage purchase orders.
        allow read, list, create, update, delete: if isBarOwnerByPath(barId);
        
        match /lines/{lineId} {
           // The bar owner can manage lines within their own purchase orders.
           allow read, list, create, update, delete: if isBarOwnerByPath(barId);
        }
      }

      match /inventorySessions/{inventorySessionId} {
        // The bar owner can manage inventory sessions for their bar.
        allow read, list, create, update, delete: if isBarOwnerByPath(barId);

        match /lines/{inventoryLineId} {
          // The bar owner can manage lines within their own inventory sessions.
          allow read, list, create, update, delete: if isBarOwnerByPath(barId);
        }
      }
    }
    
    // Catch-all rule to explicitly deny access to any other path.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
